name: Deploy Supabase Edge Functions

on:
  push:
    branches: [main]
    paths:
      - 'supabase/functions/**'
      - 'supabase/config.toml'
  workflow_dispatch:
    inputs:
      function:
        description: 'Function to deploy (blank = universal handler only)'
        required: false
        default: ''

env:
  SUPABASE_PROJECT_REF: lzyixazjquouicfsfzzu

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Set Edge Function secrets
        run: |
          supabase secrets set \
            "LOANDISK_WEBHOOK_SECRET=${{ secrets.LOANDISK_WEBHOOK_SECRET }}" \
            "FINERACT_BASE_URL=${{ secrets.FINERACT_BASE_URL }}" \
            "FINERACT_USERNAME=${{ secrets.FINERACT_USERNAME }}" \
            "FINERACT_PASSWORD=${{ secrets.FINERACT_PASSWORD }}" \
            "FINERACT_TENANT_ID=${{ secrets.FINERACT_TENANT_ID }}" \
            "FINERACT_WEBHOOK_SECRET=${{ secrets.FINERACT_WEBHOOK_SECRET }}" \
            "SUPABASE_URL=https://${SUPABASE_PROJECT_REF}.supabase.co" \
            "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            --project-ref "${SUPABASE_PROJECT_REF}"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy Fineract Edge Functions
        run: |
          for fn in fineract-webhook fineract-batch-sync fineract-reconcile fineract-loan-lifecycle; do
            echo "Deploying ${fn}..."
            supabase functions deploy "${fn}" \
              --project-ref "${SUPABASE_PROJECT_REF}" --no-verify-jwt
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy LoanDisk Edge Functions (legacy)
        if: github.event_name == 'push' || github.event.inputs.function == 'all'
        run: |
          for fn in loandisk-webhook-borrower loandisk-batch-sync loandisk-reconcile; do
            echo "Deploying ${fn}..."
            supabase functions deploy "${fn}" \
              --project-ref "${SUPABASE_PROJECT_REF}" || echo "  WARN: ${fn} deploy failed (may not exist yet)"
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy HR Edge Functions
        run: |
          for fn in hr-payroll-processor hr-leave-workflow hr-attendance hr-performance-review; do
            echo "Deploying ${fn}..."
            supabase functions deploy "${fn}" \
              --project-ref "${SUPABASE_PROJECT_REF}" --no-verify-jwt
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Verify deployments
        run: |
          echo "Verifying Fineract functions..."
          FN_URL="https://${SUPABASE_PROJECT_REF}.supabase.co/functions/v1/fineract-webhook"
          CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${FN_URL}" \
            -H "Content-Type: application/json" -d '{}')
          if [ "$CODE" = "401" ]; then
            echo "  fineract-webhook: OK (auth check returns 401)"
          else
            echo "  WARNING: fineract-webhook returned ${CODE}"
          fi

          echo "Verifying HR functions..."
          for fn in hr-payroll-processor hr-leave-workflow hr-attendance hr-performance-review; do
            HR_URL="https://${SUPABASE_PROJECT_REF}.supabase.co/functions/v1/${fn}"
            HR_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X OPTIONS "${HR_URL}" 2>/dev/null || echo "000")
            echo "  ${fn}: ${HR_CODE}"
          done
